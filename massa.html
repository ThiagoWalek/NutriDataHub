<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Massa Muscular - Controle de Saúde</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        div > canvas#massaMuscularChart {
            width: 800px;  
            height: 400px;
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="registro.html">Registrar</a></li>
            <li><a href="peso.html">Peso</a></li>
            <li><a href="gordura.html">Gordura</a></li>
            <li><a href="massa.html">Massa Muscular</a></li>
            <li><a href="dieta.html">Plano de Dieta</a></li>
            <li><a href="estatisticas.php">Estatísticas do cliente</a></li>
            <li><a href="clientela.html">Clientela</a></li>
        </ul>
    </nav>
    <div class="content">
        <h1>Massa Muscular</h1>

        <label for="dateRange">Mostrar dados de:</label>
        <select id="dateRange" onchange="updateChart()">
            <option value="7">Últimos 7 dias</option>
            <option value="30">Últimos 30 dias</option>
            <option value="12">Últimos 12 meses</option>
        </select>

        <canvas id="massaMuscularChart"></canvas>
    </div>

    <script>
        let massaMuscularChart;

        function processarDados(dados, dias) {
            const labels = [];
            const data = [];
            const hoje = new Date();

            if (dias === '12') {
                let mesAtual = hoje.getMonth();
                let anoAtual = hoje.getFullYear();
                const diaAtual = hoje.getDate();

                for (let i = 0; i < 12; i++) {
                    const dataReferencia = new Date(anoAtual, mesAtual, diaAtual);
                    const dataFormatada = dataReferencia.toISOString().split('T')[0];
                    labels.unshift(dataFormatada);

                    const registroMes = dados.find(r => r.data.startsWith(dataFormatada.slice(0, 7)));
                    if (registroMes) {
                        data.unshift(registroMes.massa);
                    } else {
                        data.unshift(null);
                    }

                    mesAtual--;
                    if (mesAtual < 0) {
                        mesAtual = 11;
                        anoAtual--;
                    }
                }
            } else {
                const diasAtras = parseInt(dias, 10);
                const dataLimite = new Date(hoje);
                dataLimite.setDate(hoje.getDate() - diasAtras);

                dados.forEach(registro => {
                    const dataRegistro = new Date(registro.data);
                    if (dataRegistro >= dataLimite && dataRegistro <= hoje) {
                        labels.push(dataRegistro.toISOString().split('T')[0]);
                        data.push(registro.massa);
                    }
                });
            }

            const ctx = document.getElementById('massaMuscularChart').getContext('2d');
            if (massaMuscularChart) {
                massaMuscularChart.destroy();
            }

            massaMuscularChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Massa Muscular (kg)',
                        data: data,
                        borderColor: 'green',
                        borderWidth: 2,
                        spanGaps: true
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function buscarDados(dias) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `load_registros.php?dias=${dias}`, true);
            xhr.onload = function () {
                if (this.status === 200) {
                    const dados = JSON.parse(this.responseText);
                    processarDados(dados, dias);
                }
            };
            xhr.send();
        }

        function updateChart() {
            const selectedRange = document.getElementById('dateRange').value;
            buscarDados(selectedRange);
        }

        window.onload = function () {
            buscarDados(7);
        };
    </script>
</body>
</html>
